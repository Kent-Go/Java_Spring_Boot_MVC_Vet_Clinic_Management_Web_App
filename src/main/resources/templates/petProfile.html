<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Pet Profile</title>
    <link rel="stylesheet" href="/css/petProfile.css" />
    <!-- Use html2pdf.js to convert html pages to pdf for download -->
    <!-- Referenced from: https://pspdfkit.com/blog/2019/html-to-pdf-in-javascript/ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <script>
      // Function to download the page as PDF
      function downloadAsPDF() {
        const petNameElement = document.getElementById("pet-name");
        if (!petNameElement) {
          console.error('Element with ID "pet-name" not found');
          return;
        }
        const petName = petNameElement.innerText || "pet";
        const cleanPetName = petName.replace(/\s+/g, "_").replace(/[^\w]/g, "");
        const element = document.body;

        const options = {
          margin: [0, 0, 0, 0], // top, right, bottom, left margins in inches
          filename: `${cleanPetName}_profile.pdf`,
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: "in", format: "a4", orientation: "portrait" }, // Set format to A4
        };

        html2pdf().set(options).from(element).save();
      }

      // Function to share the PDF via email
      async function sharePDFViaEmail() {
        try {
          await downloadAsPDF(); // Wait for the PDF download to start

          // Wait for a brief period before showing the alert
          setTimeout(() => {
            alert(
              "PDF has been downloaded. Please attach it to your email and send it to the intended recipient."
            );
          }, 1500);
        } catch (error) {
          console.error("Error generating the PDF:", error);
          alert("There was an error generating the PDF. Please try again.");
        }
      }

      // Function to validate the pet profile form
      function validatePetProfile() {
        const weight = document.getElementById("edit-weight").value;
        if (weight <= 0) {
          alert("Please enter a positive number for the weight.");
          return false;
        }
        return true;
      }

      // Function to add a new row to the immunisation history table
      function addNewRow() {
        const tbody = document.getElementById("editImmunisationTableBody");
        const row = document.createElement("tr");

        row.innerHTML = `
          <td><input type="date" name="immunisations[].date" required /></td>
          <td><input type="text" name="immunisations[].name" required /></td>
          <td><input type="text" name="immunisations[].notes" /></td>
        `;

        tbody.appendChild(row);
      }

      // Function to update hidden fields with delimiter before form submission
      function updateHiddenFields() {
        var nameValue = document.getElementById("nameDisplay").value;
        var instructionValue =
          document.getElementById("instructionDisplay").value;

        // Append the delimiter and set it to the hidden field
        document.getElementById("nameHidden").value = nameValue + "|";
        document.getElementById("instructionHidden").value =
          instructionValue + "|";
      }

      // Function to validate medication details form
      function validateEditMedication() {
        const dosage = parseFloat(
          document.getElementById("edit-medDosage").value
        );
        const frequency = parseFloat(
          document.getElementById("edit-medFrequency").value
        );
        const duration = parseFloat(
          document.getElementById("edit-medDuration").value
        );

        if (
          isNaN(dosage) ||
          dosage <= 0 ||
          isNaN(frequency) ||
          frequency <= 0 ||
          isNaN(duration) ||
          duration <= 0
        ) {
          alert(
            "Please enter positive numbers for the dosage, daily frequency, and duration."
          );
          return false;
        }
        return true;
      }

      function deleteMedication(medicationId) {
        const petIdElement = document.querySelector("input[name='petId']");
        if (!petIdElement) {
          console.error("petId element not found.");
          alert("Error: petId element is missing.");
          return;
        }

        console.log("medicationId:", medicationId); // Log the medicationId value for debugging

        const petId = petIdElement.value;
        console.log("petId:", petId); // Log the petId value for debugging

        if (!medicationId) {
          console.error("medicationId is not defined.");
          alert("Error: medicationId is missing.");
          return;
        }

        if (confirm("Are you sure you want to delete this medication?")) {
          fetch(`/deleteMedication/${medicationId}?petId=${petId}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("Response data:", data);
              if (data.message === "Medication deleted successfully") {
                alert(data.message);
                window.location.href = data.redirectUrl;
              } else {
                throw new Error(data.message);
              }
            })
            .catch((error) => {
              console.error("Error deleting medication:", error);
              alert("An error occurred while deleting medication.");
            });
        }
      }

      // Ensure hidden fields are updated when form is submitted
      document.addEventListener("DOMContentLoaded", function () {
        // Function to get query parameters from the URL
        function getQueryParams() {
          const params = new URLSearchParams(window.location.search);
          const error = params.get("error");
          return { error };
        }

        // Function to display an alert if an error query parameter is present
        function checkForErrors() {
          const { error } = getQueryParams();
          if (error === "Medicine does not exist!") {
            alert("Medicine does not exist!");
          }
        }

        // Check for errors when the page loads
        checkForErrors();

        var editMedicationForm = document.getElementById("editMedicationForm");
        if (editMedicationForm) {
          editMedicationForm.addEventListener("submit", function (event) {
            updateHiddenFields();
            if (!validateEditMedication()) {
              event.preventDefault(); // Prevent form submission if validation fails
            }
          });
        }
      });
    </script>
  </head>
  <body>
    <div class="header">
      <a href="/">
        <img src="/images/logo.png" alt="Logo" class="logo" />
      </a>
      <a href="/" class="profile-link">
        <img src="/images/profile.png" alt="Profile" class="profile-icon" />
      </a>
    </div>

    <div class="container">
      <div class="pet-info-header">
        <span style="font-size: 1.5em">Pet Profile</span>
        <div class="icons-container">
          <img
            src="/images/share-icon.png"
            class="share-icon"
            alt="Share"
            title="Share via Email"
            onclick="sharePDFViaEmail()"
          />
          <img
            src="/images/download-icon.png"
            class="download-icon"
            alt="Download"
            title="Download as PDF"
            onclick="downloadAsPDF()"
          />
        </div>
      </div>

      <!-- View Mode for Pet Information -->
      <div th:if="${!editMode}">
        <div class="pet-profile-card">
          <div class="pet-info-box">
            <div class="pet-info-header">
              Pet Information
              <a th:href="@{/petProfile(petId=${pet.id}, editMode=true)}">
                <img src="/images/edit-icon.png" class="edit-icon" alt="Edit" />
              </a>
            </div>
            <div class="pet-info-content">
              <div class="pet-picture">
                <img
                  id="pet-picture"
                  src="/images/pet-placeholder.jpeg"
                  alt="Pet Picture"
                />
              </div>
              <div class="pet-details">
                <p>
                  <strong>Pet Name:</strong>
                  <span id="pet-name" th:text="${pet.name}"></span>
                </p>
                <p>
                  <strong>Birth Date: </strong>
                  <span th:text="${pet.birthDate}"></span>
                </p>
                <p>
                  <strong>Species: </strong>
                  <span th:text="${pet.species}"></span>
                </p>
                <p>
                  <strong>Breed: </strong>
                  <span th:text="${pet.breed}"></span>
                </p>
                <p>
                  <strong>Gender: </strong>
                  <span th:text="${pet.gender}"></span>
                </p>
                <p>
                  <strong>Weight: </strong>
                  <span th:text="${pet.weight}"></span>
                  kg
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Mode for Pet Information -->
      <div th:if="${editMode}">
        <form
          action="/updatePetProfile"
          method="POST"
          enctype="multipart/form-data"
          onsubmit="return validatePetProfile()"
        >
          <input type="hidden" name="petId" th:value="${pet.id}" />
          <!-- Hidden input for petId -->
          <div class="pet-profile-card">
            <div class="pet-info-box">
              <div class="pet-info-header">Edit Pet Information</div>
              <div class="pet-info-content">
                <div class="pet-details">
                  <p>
                    <strong>Pet Name:</strong>
                    <input
                      type="text"
                      id="edit-petName"
                      name="name"
                      th:value="${pet.name}"
                      required
                    />
                  </p>
                  <p>
                    <strong>Birth Date:</strong>
                    <input
                      type="date"
                      id="edit-birthDate"
                      name="birthDate"
                      th:value="${pet.birthDate}"
                      required
                    />
                  </p>
                  <p>
                    <strong>Species:</strong>
                    <input
                      type="text"
                      id="edit-species"
                      name="species"
                      th:value="${pet.species}"
                      required
                    />
                  </p>
                  <p>
                    <strong>Breed:</strong>
                    <input
                      type="text"
                      id="edit-breed"
                      name="breed"
                      th:value="${pet.breed}"
                      required
                    />
                  </p>
                  <p>
                    <strong>Gender:</strong>
                    <select id="edit-gender" name="gender">
                      <option
                        value="Male"
                        th:selected="${pet.gender == 'Male'}"
                      >
                        Male
                      </option>
                      <option
                        value="Female"
                        th:selected="${pet.gender == 'Female'}"
                      >
                        Female
                      </option>
                    </select>
                  </p>
                  <p>
                    <strong>Weight:</strong>
                    <input
                      type="text"
                      id="edit-weight"
                      name="weight"
                      th:value="${pet.weight}"
                      required
                    />
                  </p>
                </div>
              </div>
              <button
                type="button"
                th:onclick="'window.location.href=\'/petProfile?petId=' + ${pet.id} + '\''"
              >
                Cancel
              </button>
              <button type="submit">Save Changes</button>
            </div>
          </div>
        </form>
      </div>

      <!-- View Mode for Medication -->
      <div th:if="${!editMedicationMode}">
        <div class="pet-profile-card">
          <div class="pet-info-box">
            <div class="pet-info-header">
              Pet Medication
              <a
                th:href="@{/petProfile(petId=${pet.id}, editMedicationMode=true)}"
              >
                <img src="/images/edit-icon.png" class="edit-icon" alt="Edit" />
              </a>
            </div>
            <div class="pet-info-content">
              <div class="medication-details">
                <div th:if="${#lists.isEmpty(prescribedMedications)}">
                  <p>No medications prescribed.</p>
                </div>
                <div th:if="${!#lists.isEmpty(prescribedMedications)}">
                  <ol>
                    <li th:each="medication : ${prescribedMedications}">
                      <p>
                        <strong>Name:</strong>
                        <span th:text="${medication.medicine.name}"></span>
                      </p>
                      <p>
                        <strong>Dosage:</strong>
                        <span th:text="${medication.dosage}"></span>
                      </p>
                      <p>
                        <strong>Daily Frequency:</strong>
                        <span th:text="${medication.dailyFrequency}"></span>
                      </p>
                      <p>
                        <strong>Duration:</strong>
                        <span th:text="${medication.duration}"></span>
                        days
                      </p>
                      <p>
                        <strong>Instruction:</strong>
                        <span th:text="${medication.instruction}"></span>
                      </p>
                    </li>
                  </ol>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Existing Medication -->
      <div th:if="${editMedicationMode}">
        <form
          id="editMedicationForm"
          th:action="@{/updateMedication}"
          method="POST"
          onsubmit="return validateEditMedication();"
        >
          <input type="hidden" name="petId" th:value="${pet.id}" />

          <div class="pet-profile-card">
            <div class="pet-info-box">
              <div class="pet-info-header">Edit Medications</div>
              <div class="pet-info-content">
                <div class="medication-details">
                  <!-- Loop over medications to show details -->
                  <div
                    th:each="medication, iterStat : ${prescribedMedications}"
                    style="margin-bottom: 1rem"
                  >
                    <!-- This could be hidden or visible based on the selected medication -->
                    <input
                      type="hidden"
                      name="medicationId"
                      th:value="${medication.id}"
                    />
                    <p>
                      <strong>Name:</strong>
                      <!-- Visible input field for user -->
                      <input
                        type="text"
                        id="nameDisplay"
                        name="nameDisplay"
                        th:value="${medication.medicine.name}"
                        required
                        class="large-textbox"
                      />
                      <!-- Hidden input field with delimiter -->
                      <input
                        type="hidden"
                        id="nameHidden"
                        name="name"
                        th:value="${medication.medicine.name} + '|'"
                      />
                    </p>
                    <p>
                      <strong>Dosage:</strong>
                      <input
                        type="text"
                        name="dosage"
                        th:value="${medication.dosage}"
                        required
                      />
                    </p>
                    <p>
                      <strong>Daily Frequency:</strong>
                      <input
                        type="text"
                        name="frequency"
                        th:value="${medication.dailyFrequency}"
                        required
                      />
                    </p>
                    <p>
                      <strong>Duration:</strong>
                      <input
                        type="text"
                        name="duration"
                        th:value="${medication.duration}"
                        required
                      />
                    </p>
                    <p>
                      <strong>Instruction:</strong>
                      <!-- Visible input field for user -->
                      <input
                        type="text"
                        id="instructionDisplay"
                        name="instructionDisplay"
                        th:value="${medication.instruction}"
                        required
                        class="large-textbox"
                      />
                      <!-- Hidden input field with delimiter -->
                      <input
                        type="hidden"
                        id="instructionHidden"
                        name="instruction"
                        th:value="${medication.instruction} + '|'"
                      />
                    </p>

                    <!-- Buttons for saving or deleting the medication -->
                    <button type="submit">Save Changes</button>
                    <button
                      type="button"
                      th:attr="onclick='deleteMedication(' + ${medication.id} + ')'"
                    >
                      Delete Medication
                    </button>
                    <hr style="margin-top: 1rem" />
                  </div>
                </div>
              </div>
            </div>
          </div>
          <a th:href="@{/petProfile(petId=${pet.id})}">
            <button type="button" style="margin-bottom: 1rem">Cancel</button>
          </a>
        </form>
      </div>

      <!-- View Mode for Health Concerns -->
      <div th:if="${!editHealthConcernsMode}">
        <div class="pet-profile-card">
          <div class="pet-info-box">
            <div class="pet-info-header">
              Health Concerns
              <a
                th:href="@{/petProfile(petId=${pet.id}, editHealthConcernsMode=true)}"
              >
                <img src="/images/edit-icon.png" class="edit-icon" alt="Edit" />
              </a>
            </div>
            <div class="pet-info-content">
              <div class="pet-details">
                <p>
                  <strong>Allergies:</strong>
                  <span th:text="${pet.allergies}"></span>
                </p>
                <p>
                  <strong>Existing Conditions:</strong>
                  <span th:text="${pet.existingConditions}"></span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Mode for Health Concerns -->
      <div th:if="${editHealthConcernsMode}">
        <form action="/updateHealthConcerns" method="POST">
          <input type="hidden" name="petId" th:value="${pet.id}" />
          <div class="pet-profile-card">
            <div class="pet-info-box">
              <div class="pet-info-header">Edit Health Concerns</div>
              <div class="pet-info-content">
                <div class="pet-details">
                  <p>
                    <strong>Allergies:</strong>
                    <input
                      type="text"
                      id="edit-allergies"
                      name="allergies"
                      th:value="${pet.allergies}"
                      class="large-textbox"
                    />
                  </p>
                  <p>
                    <strong>Existing Conditions:</strong>
                    <input
                      type="text"
                      id="edit-existingConditions"
                      name="existingConditions"
                      th:value="${pet.existingConditions}"
                      class="large-textbox"
                    />
                  </p>
                </div>
              </div>
              <a th:href="@{/petProfile(petId=${pet.id})}">
                <button type="button" style="margin-bottom: 1rem">
                  Cancel
                </button>
              </a>
              <button type="submit">Save Changes</button>
            </div>
          </div>
        </form>
      </div>

      <!-- View Mode for Owner's Information -->
      <div id="viewOwnerInfoMode">
        <div class="owner-profile-card">
          <div class="owner-info-box">
            <div class="owner-info-header">Owner's Information</div>
            <div class="owner-info-content">
              <div class="owner-details">
                <p>
                  <strong>Name: </strong
                  ><span
                    th:text="${pet.petOwner.user.firstName} + ' ' + ${pet.petOwner.user.lastName}"
                  ></span>
                </p>
                <p>
                  <strong>Phone: </strong
                  ><span th:text="${pet.petOwner.user.phoneNumber}"></span>
                </p>
                <p>
                  <strong>Home Address: </strong>
                  <span
                    th:text="${address.street} + ' ' + ${address.suburb} + ' ' + ${address.postcode} + ' ' + ${address.state}"
                  ></span>
                </p>
                <p>
                  <strong>Email: </strong>
                  <span th:text="${pet.petOwner.user.email}"></span>
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- View Mode for Immunisation History -->
      <div th:if="${!editImmunisationMode}">
        <div class="immunisation-profile-card">
          <div class="immunisation-info-box">
            <div class="immunisation-info-header">
              Immunisation History
              <a
                th:href="@{/petProfile(petId=${pet.id}, editImmunisationMode=true)}"
              >
                <img src="/images/edit-icon.png" class="edit-icon" alt="Edit" />
              </a>
            </div>
            <div class="immunisation-info-content">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Vaccination</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="immunisation : ${immunisationHistories}">
                    <td
                      class="immunisation-date-column"
                      th:text="${immunisation.date}"
                    ></td>
                    <td
                      class="immunisation-name-column"
                      th:text="${immunisation.name}"
                    ></td>
                    <td th:text="${immunisation.notes}"></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Mode for Immunisation History -->
      <div th:if="${editImmunisationMode}">
        <form
          id="editImmunisationForm"
          action="/updateImmunisationHistory"
          method="POST"
          onsubmit="return validateImmunisationForm()"
        >
          <input type="hidden" name="petId" th:value="${pet.id}" />
          <div class="immunisation-profile-card">
            <div class="immunisation-info-box">
              <div class="immunisation-info-header">
                Edit Immunisation History
              </div>
              <div class="immunisation-info-content">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Vaccination</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="editImmunisationTableBody">
                    <tr
                      th:each="immunisation, iterStat : ${immunisationHistories}"
                    >
                      <td>
                        <input
                          type="date"
                          name="immunisations[${iterStat.index}].date"
                          th:value="${immunisation.date}"
                          required
                        />
                      </td>
                      <td>
                        <input
                          type="text"
                          name="immunisations[${iterStat.index}].name"
                          th:value="${immunisation.name}"
                          required
                        />
                      </td>
                      <td>
                        <input
                          type="text"
                          name="immunisations[${iterStat.index}].notes"
                          th:value="${immunisation.notes}"
                        />
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <button type="button" onclick="addNewRow()">Add New Row</button>
              <a th:href="@{/petProfile(petId=${pet.id})}">
                <button type="button">Cancel</button>
              </a>
              <button type="submit">Save Changes</button>
            </div>
          </div>
        </form>
      </div>

      <!-- View Mode for Surgery History -->
      <div th:if="${!editSurgeryMode}">
        <div class="surgery-profile-card">
          <div class="surgery-info-box">
            <div class="surgery-info-header">
              Surgery History
              <a
                th:href="@{/petProfile(petId=${pet.id}, editSurgeryMode=true)}"
              >
                <img src="/images/edit-icon.png" class="edit-icon" alt="Edit" />
              </a>
            </div>
            <div class="surgery-info-content">
              <table>
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Surgery Name</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tr th:each="surgery : ${surgeryHistories}">
                  <td
                    class="surgery-date-column"
                    th:text="${surgery.date}"
                  ></td>
                  <td
                    class="surgery-name-column"
                    th:text="${surgery.name}"
                  ></td>
                  <td th:text="${surgery.notes}"></td>
                </tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit Mode for Surgery History -->
      <div th:if="${editSurgeryMode}">
        <form onsubmit="saveSurgeryHistory(); return false;">
          <div class="surgery-profile-card">
            <div class="surgery-info-box">
              <div class="surgery-info-header">Edit Surgery History</div>
              <div class="surgery-info-content">
                <table>
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Surgery Type/Name</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="editSurgeryTableBody"></tbody>
                </table>
              </div>
              <button type="button" onclick="addNewSurgeryRow()">
                Add New Row
              </button>
              <a th:href="@{/petProfile(petId=${pet.id})}">
                <button type="button">Cancel</button>
              </a>
              <button type="submit">Save Changes</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </body>
</html>
