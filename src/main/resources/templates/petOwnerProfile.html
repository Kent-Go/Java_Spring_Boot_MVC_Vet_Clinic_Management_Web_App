<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Pet Owner Profile</title>
    <link rel="stylesheet" href="/css/petOwnerProfile.css" />
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const userID = localStorage.getItem("userId");
            const petOwnerID = localStorage.getItem("petOwnerId");

            if (petOwnerID && userID) {
                const petOwnerDashboardLink = document.querySelector("#pet-owner-dashboard-link");
                const logoLink = document.querySelector("#logo-link");
                const profileLink = document.querySelector("#profile-link");

                if (petOwnerDashboardLink) {
                    petOwnerDashboardLink.href = `/petOwnerWelcome?userId=${userID}&petOwnerId=${petOwnerID}`;
                }
                if (logoLink) {
                    logoLink.href = `/petOwnerWelcome?userId=${userID}&petOwnerId=${petOwnerID}`;
                }
                if (profileLink) {
                    profileLink.href = `/petOwnerProfile?petOwnerId=${petOwnerID}`;
                }
            } else {
                console.log("petOwnerId or userId is missing from localStorage.");
            }
        });

        function editProfile() {
            document.getElementById("viewMode").style.display = "none";
            document.getElementById("editMode").style.display = "block";
        }

        function cancelEdit() {
            document.getElementById("editMode").style.display = "none";
            document.getElementById("viewMode").style.display = "block";
        }

        async function saveProfile() {
            const userID = localStorage.getItem("userId");
            const petOwnerID = localStorage.getItem("petOwnerId");

            const formData = {
                firstName: document.getElementById("edit-firstname").value,
                lastName: document.getElementById("edit-lastname").value,
                birthDate: document.getElementById("edit-dob").value,
                gender: document.getElementById("edit-gender").value,
                phone: document.getElementById("edit-phone").value,
                email: document.getElementById("edit-email").value,
                street: document.getElementById("edit-streetAddress").value,
                suburb: document.getElementById("edit-suburb").value,
                state: document.getElementById("edit-state").value,
                postcode: document.getElementById("edit-postcode").value
            };

            try {
                const response = await fetch(`/petOwnerProfile?petOwnerId=${petOwnerID}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(formData),
                });

                if (response.ok) {
                    location.reload();
                } else {
                    console.error("Error saving profile.");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        function logout() {
            window.location.href = "/login";
        }

        window.onload = loadProfile;
    </script>
</head>
<body>
<div class="header">
    <a th:href="@{/petOwnerWelcome(userId=${petOwner.user.id})}" id="logo-link">
        <img src="/images/logo.png" alt="Logo" class="logo" />
    </a>
    <a
            th:href="@{/petOwnerProfile(petOwnerId=${petOwner.id})}"
            id="profile-link"
            class="profile-link"
    >
        <img src="/images/profile.png" alt="Profile" class="profile-icon" />
    </a>
</div>

<div class="navbar">
    <ul>
        <li>
            <a th:href="@{/petOwnerWelcome(userId=${petOwner.user.id})}" class="active"
            >Home</a
            >
        </li>
        <li><a th:href="@{/petList}">Pets</a></li>
        <li><a href="/trendsHome">Articles & Videos</a></li>
        <li><a href="#consultation">Consultation</a></li>
        <li><a href="#prescriptions">Prescriptions</a></li>
        <li><a href="#faq">FAQ</a></li>
    </ul>
</div>
<div class="profile-container">
    <h1>Profile Details</h1>
    <div class="profile-card">
        <div id="viewMode">
            <div class="profile-picture">
                <img id="profile-picture" src="/images/profile-placeholder.png" alt="Profile Picture" />
            </div>
            <div class="profile-info">
                <p><strong>First Name:</strong> <span th:text="${user.firstName}"></span></p>
                <p><strong>Last Name:</strong> <span th:text="${user.lastName}"></span></p>
                <p><strong>Date of Birth:</strong> <span th:text="${user.birthDate}"></span></p>
                <p><strong>Gender:</strong> <span th:text="${user.gender}"></span></p>
                <p><strong>Phone Number:</strong> <span th:text="${user.phoneNumber}"></span></p>
                <p><strong>Email:</strong> <span th:text="${user.email}"></span></p>

                <h3>Address</h3>
                <p><strong>Street Address:</strong> <span th:text="${address.street}"></span></p>
                <p><strong>Suburb:</strong> <span th:text="${address.suburb}"></span></p>
                <p><strong>State:</strong> <span th:text="${address.state}"></span></p>
                <p><strong>Postcode:</strong> <span th:text="${address.postcode}"></span></p>

                <div class="profile-actions">
                    <button type="button" class="edit-button" onclick="editProfile()">Edit Profile</button>
                    <button type="button" class="logout-button" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <div id="editMode" style="display: none">
            <form id="profileForm" onsubmit="saveProfile(); return false;">
                <div class="profile-picture">
                    <img id="edit-profilePicturePreview" src="/images/profile-placeholder.png" alt="Profile Picture" />
                    <input type="file" id="edit-profilePicture" name="profilePicture" accept="image/*" />
                    <label id="edit-profilePicturePlaceholder">No file chosen</label>
                </div>
                <div class="profile-info">
                    <p><strong>First Name:</strong><input type="text" id="edit-firstname" name="firstname" th:value="${user.firstName}" placeholder="First Name" required /></p>
                    <p><strong>Last Name:</strong><input type="text" id="edit-lastname" name="lastname" th:value="${user.lastName}" placeholder="Last Name" required /></p>
                    <p><strong>Date of Birth:</strong><input type="date" id="edit-dob" name="dob" th:value="${user.birthDate}" required /></p>
                    <p><strong>Gender:</strong><select id="edit-gender" name="gender">
                        <option th:each="gender : ${genders}" th:value="${gender}" th:text="${gender}" th:selected="${gender == user.gender}"></option>
                    </select></p>
                    <p><strong>Phone Number:</strong><input type="tel" id="edit-phone" name="phone" th:value="${user.phoneNumber}" placeholder="Phone Number" required /></p>
                    <p><strong>Email:</strong><input type="email" id="edit-email" name="email" th:value="${user.email}" placeholder="Email" required /></p>

                    <h3>Address</h3>
                    <p><strong>Street Address:</strong><input type="text" id="edit-streetAddress" name="streetAddress" th:value="${address.street}" placeholder="Street Address" required /></p>
                    <p><strong>Suburb:</strong><input type="text" id="edit-suburb" name="suburb" th:value="${address.suburb}" placeholder="Suburb" required /></p>
                    <p><strong>State:</strong><input type="text" id="edit-state" name="state" th:value="${address.state}" placeholder="State" required /></p>
                    <p><strong>Postcode:</strong><input type="text" id="edit-postcode" name="postcode" th:value="${address.postcode}" placeholder="Postcode" required /></p>

                    <div class="profile-actions">
                        <button type="button" class="cancel-button" onclick="cancelEdit()">Cancel</button>
                        <button type="submit" class="save-button">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>
