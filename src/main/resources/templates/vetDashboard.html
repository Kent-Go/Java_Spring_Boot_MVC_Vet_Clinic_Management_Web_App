<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Vet Dashboard</title>
    <link rel="stylesheet" href="/css/vetDashboard.css" />
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Fetch the userId from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const urlUserID = urlParams.get("userId");

        // Check if userId is not already stored
        if (urlUserID && !localStorage.getItem("userId")) {
          localStorage.setItem("userId", urlUserID);
        }

        // Fetch the vet ID from the API
        const userID = localStorage.getItem("userId");
        if (userID) {
          // Fetch vet details based on userId through the API
          fetch(`/api/vets/${userID}`)
            .then((response) => response.json())
            .then((data) => {
              const vetID = data.id;
              const scheduleLink = document.querySelector(".schedule-link");
              const profileLink = document.querySelector("#profile-link");

              localStorage.setItem("vetId", vetID);

              if (vetID) {
                // Calculate the start date of the current week (e.g., Monday of the current week)
                const now = new Date();
                const startOfWeek = new Date(
                  now.setDate(now.getDate() - now.getDay() + 1)
                ); // Monday
                const weekStart = startOfWeek.toISOString().split("T")[0]; // Format as YYYY-MM-DD

                // Set the schedule link with vetId and weekStart
                const newHref = `schedule?vetId=${vetID}&weekStart=${weekStart}`;
                console.log("Setting schedule link href to:", newHref); // Log the new href
                scheduleLink.href = newHref;

                if (profileLink) {
                  profileLink.href = `/profile?vetId=${vetID}`;
                }
              } else {
                console.error("Vet ID not found");
              }
            })
            .catch((error) => console.error("Error fetching vet ID:", error));
        }
      });
    </script>
  </head>
  <body>
    <div class="header">
      <a href="javascript:void(0)" onclick="window.location.reload()">
        <img src="/images/logo.png" alt="Logo" class="logo" />
      </a>
      <a href="#" id="profile-link" class="profile-link">
        <img src="/images/profile.png" alt="Profile" class="profile-icon" />
      </a>
    </div>

    <div class="nav-bar">
      <a
        href="javascript:void(0)"
        onclick="window.location.reload()"
        class="active"
        >Home</a
      >
      <a href="patients">Patients</a>
      <a href="#" class="schedule-link">Schedule</a>
      <a href="availability">Availability</a>
      <a href="vetFaq">FAQ</a>
    </div>

    <div class="container">
      <h1 id="welcomeName">Welcome, Doctor</h1>
      <!-- Placeholder text, will be replaced by JS -->
      <h2>Your Appointments Today</h2>
      <div class="appointment">
        <h3>
          <span
            th:text="${#temporals.format(today, 'EEEE, dd MMMM yyyy')}"
          ></span>
        </h3>

        <div th:each="appointment, iterStat : ${appointments}">
          <div class="appointment-card">
            <h4
              th:text="${iterStat.count + '. ' + appointment.appointmentType.name + ' at ' + appointment.startTime}"
            ></h4>
            <p>
              <strong>Patient:</strong>
              <span th:text="${appointment.pet.name}"></span>
            </p>
            <p>
              <strong>Gender:</strong>
              <span th:text="${appointment.pet.gender}"></span>
            </p>
            <p>
              <strong>Species:</strong>
              <span th:text="${appointment.pet.species}"></span>
            </p>
            <p>
              <strong>Breed:</strong>
              <span th:text="${appointment.pet.breed}"></span>
            </p>
            <hr />
            <p>
              <strong>Pet Owner:</strong>
              <span th:text="${appointment.pet.petOwner.user.firstName + ' ' + appointment.pet.petOwner.user.lastName}">N/A</span>
            </p>
            <p>
              <strong>Email:</strong>
              <span th:text="${appointment.pet.petOwner.user.email}"></span>
            </p>
            <p>
              <strong>Number:</strong> +<span
                th:text="${appointment.pet.petOwner.user.phoneNumber}"
              ></span>
            </p>
            <button>Pet Details</button>
            <button>Owner Details</button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
